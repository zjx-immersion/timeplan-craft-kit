# 完整功能实施计划 - timeplan-craft-kit 📋

**开始日期**: 2026-02-07  
**当前状态**: 🚀 执行中  
**完成度**: 75% → 目标 100%

---

## 📊 功能缺口总览

根据`FEATURE-MIGRATION-ANALYSIS.md`分析，当前还有**25%的关键功能**需要复刻：

| 功能类别 | 完成度 | 优先级 | 预计工作量 | 状态 |
|---------|-------|--------|-----------|------|
| **基线系统** | 0% | P1 ⭐⭐⭐⭐⭐ | 1-2天 | 🔴 待开始 |
| **节点右键菜单** | 0% | P1 ⭐⭐⭐⭐ | 0.5-1天 | 🔴 待开始 |
| **导出图片** | 0% | P1 ⭐⭐⭐ | 0.5-1天 | 🔴 待开始 |
| **Timeline时间平移** | 0% | P1 ⭐⭐⭐ | 0.5天 | 🔴 待开始 |
| **嵌套计划导航** | 30% | P1 ⭐⭐⭐ | 1天 | 🟡 部分完成 |
| **迭代规划增强** | 60% | P2 | 1天 | 🟡 部分完成 |
| **其他优化** | - | P2-P3 | 1-2天 | 🔴 待开始 |

**总工作量**: 5-8天

---

## 🎯 实施路线图

### Phase 1: 核心功能复刻（本次会话，优先级P1）

#### ✅ 已完成基础架构
- ✅ 布局重构（固定Header和Toolbar）
- ✅ 视图切换验证
- ✅ 编辑模式基础功能
- ✅ 撤销/重做机制

#### 🔥 本次实施重点（按优先级）

##### 1️⃣ 基线系统 (P1 - 最高优先级) ⭐⭐⭐⭐⭐
**为什么最重要？**
- 基线是项目管理的核心功能
- 用于标记关键时间点和阶段
- 源项目中使用频率高
- 数据模型已存在，只需UI实现

**需要复刻的组件**:
```
src/components/timeline/
├── BaselineMarker.tsx                  // 基线标记（垂直线）
├── BaselineRangeMarker.tsx             // 基线范围标记（矩形区域）
├── BaselineRangeDragCreator.tsx        // 拖拽创建基线范围
├── BaselineEditDialog.tsx              // 基线编辑对话框
└── BaselineRangeEditDialog.tsx         // 基线范围编辑对话框
```

**功能清单**:
- [ ] 在时间轴上渲染基线（垂直线 + 标签）
- [ ] 在时间轴上渲染基线范围（半透明矩形 + 标签）
- [ ] 拖拽创建基线范围
- [ ] 编辑基线（日期、名称、颜色）
- [ ] 编辑基线范围（开始日期、结束日期、名称、颜色、描述）
- [ ] 删除基线/基线范围
- [ ] 右键菜单入口（Timeline右键 → 添加基线/基线范围）

**技术要点**:
- 使用SVG渲染基线标记
- z-index需要在时间轴和节点之间
- 支持拖拽创建（mousedown → mousemove → mouseup）
- 颜色可选（预设颜色 + 自定义）

**测试验证**:
- [ ] 基线显示正确
- [ ] 基线范围显示正确
- [ ] 拖拽创建流畅
- [ ] 编辑保存成功
- [ ] 删除功能正常

---

##### 2️⃣ 节点右键菜单 (P1) ⭐⭐⭐⭐
**为什么重要？**
- 提升编辑效率
- 符合用户操作习惯
- 快速访问常用功能

**需要复刻的组件**:
```
src/components/timeline/
└── NodeContextMenu.tsx                 // 节点上下文菜单
```

**功能清单**:
- [ ] 编辑节点（打开编辑对话框）
- [ ] 删除节点
- [ ] 复制节点
- [ ] 转换节点类型（Bar ↔ Milestone ↔ Gateway）
- [ ] 添加依赖关系（进入连接模式）
- [ ] 添加到基线（选择基线）
- [ ] 查看嵌套计划（如果有nestedPlanId）
- [ ] 添加备注

**技术要点**:
- 使用Ant Design Dropdown组件
- 右键点击节点触发（onContextMenu事件）
- 根据节点类型动态显示/隐藏菜单项
- 菜单项图标使用@ant-design/icons

**测试验证**:
- [ ] 右键显示菜单
- [ ] 所有功能正常
- [ ] Bar/Milestone/Gateway都可用
- [ ] 菜单位置正确

---

##### 3️⃣ 导出图片功能 (P1) ⭐⭐⭐
**为什么重要？**
- 项目演示必备
- 文档制作需求
- 汇报PPT使用

**需要复刻的功能**:
```
src/utils/
└── imageExport.ts                      // 图片导出工具

src/components/dialogs/
└── ExportDialog.tsx (扩展)             // 导出对话框
```

**功能清单**:
- [ ] 导出为PNG（推荐）
- [ ] 导出为JPEG
- [ ] 导出为SVG（矢量图）
- [ ] 分辨率选择（1x/2x/3x）
- [ ] 导出范围选择（当前视图/完整计划）
- [ ] 文件名自定义
- [ ] 导出进度提示

**技术要点**:
- 使用`html2canvas`库（PNG/JPEG）
- 使用原生SVG导出（SVG格式）
- 导出前隐藏UI控件（工具栏、快速菜单等）
- 导出后恢复UI控件
- 高分辨率导出需要缩放

**依赖安装**:
```bash
pnpm add html2canvas
pnpm add -D @types/html2canvas
```

**测试验证**:
- [ ] PNG导出清晰
- [ ] JPEG导出正常
- [ ] SVG导出可用
- [ ] 高分辨率导出清晰
- [ ] 文件名正确

---

##### 4️⃣ Timeline时间平移 (P1) ⭐⭐⭐
**为什么重要？**
- 批量调整日期的高效工具
- 项目延期场景常用
- 节省手动调整时间

**需要复刻的组件**:
```
src/components/timeline/
└── TimelineTimeShiftDialog.tsx         // 时间平移对话框
```

**功能清单**:
- [ ] 选择Timeline
- [ ] 输入偏移天数（支持正负数）
- [ ] 预览变更
- [ ] 保持依赖关系选项
- [ ] 批量调整所有节点日期
- [ ] 撤销支持

**技术要点**:
- 使用Ant Design Modal + Form
- 日期计算使用date-fns
- 预览变更使用表格展示（旧日期 → 新日期）
- 保持依赖关系需要检查关联节点

**测试验证**:
- [ ] 偏移天数计算正确
- [ ] 预览数据准确
- [ ] 保存后日期正确更新
- [ ] 依赖关系保持正确

---

##### 5️⃣ 嵌套计划导航 (P1) ⭐⭐⭐
**为什么重要？**
- 支持多层级计划管理
- 大型项目必备功能
- 数据模型已支持（nestedPlanId）

**需要实现**:
```
src/pages/
└── LineDetail.tsx                      // 嵌套计划详情页

src/components/
└── BreadcrumbNav.tsx                   // 面包屑导航
```

**功能清单**:
- [ ] 双击节点打开嵌套计划（如果有nestedPlanId）
- [ ] 面包屑导航（显示层级路径）
- [ ] 返回上级按钮
- [ ] URL路由支持（`/plan/:planId/line/:lineId`）
- [ ] 嵌套计划图标标识（节点右上角显示子计划图标）

**技术要点**:
- 路由配置扩展（react-router-dom）
- 双击事件（onDoubleClick）
- 面包屑使用Ant Design Breadcrumb
- URL参数解析（useParams）
- 返回导航（useNavigate）

**测试验证**:
- [ ] 双击打开嵌套计划
- [ ] 面包屑显示正确
- [ ] 返回功能正常
- [ ] URL正确
- [ ] 多层嵌套支持

---

### Phase 2: 功能增强（后续会话，优先级P2）

##### 6️⃣ 迭代规划增强
- [ ] 增强MR管理功能
- [ ] 优化迭代矩阵交互
- [ ] 添加迭代宽度调节
- [ ] 完善依赖可视化
- [ ] MR详情对话框优化

##### 7️⃣ Timeline右键菜单扩展
当前缺失功能：
- [ ] 添加基线
- [ ] 添加基线范围
- [ ] Timeline时间平移
- [ ] 批量编辑
- [ ] Timeline排序

##### 8️⃣ 导入导出增强
- [ ] CSV导出验证和优化
- [ ] Excel导出验证和优化
- [ ] 导入模式选择（合并/替换）
- [ ] 数据验证增强
- [ ] 导入错误提示

##### 9️⃣ 备注侧边栏
- [ ] 复刻NotesSidebar组件
- [ ] 集成Markdown编辑器
- [ ] 侧边栏显示/隐藏动画
- [ ] 备注保存和加载

---

### Phase 3: 优化和扩展（可选，优先级P3）

- [ ] 打印功能
- [ ] 主题切换（Light/Dark）
- [ ] 触摸手势支持（移动端）
- [ ] 批量操作对话框
- [ ] 高级筛选功能
- [ ] 快捷键自定义
- [ ] 性能优化（虚拟滚动、懒加载）

---

## 📅 本次会话实施计划

### 目标：完成Phase 1的关键功能

#### Step 1: 基线系统（1-2小时）✅
1. [ ] 分析源项目基线组件实现
2. [ ] 创建BaselineMarker.tsx
3. [ ] 创建BaselineRangeMarker.tsx
4. [ ] 创建BaselineEditDialog.tsx
5. [ ] 创建BaselineRangeEditDialog.tsx
6. [ ] 创建BaselineRangeDragCreator.tsx
7. [ ] 集成到TimelinePanel
8. [ ] 添加右键菜单入口
9. [ ] 测试验证

#### Step 2: 节点右键菜单（30-60分钟）
1. [ ] 分析源项目菜单实现
2. [ ] 创建NodeContextMenu.tsx
3. [ ] 实现所有菜单功能
4. [ ] 集成到LineRenderer
5. [ ] 测试验证

#### Step 3: 导出图片（30-60分钟）
1. [ ] 安装html2canvas依赖
2. [ ] 创建imageExport.ts
3. [ ] 扩展ExportDialog.tsx
4. [ ] 集成到Toolbar
5. [ ] 测试各种格式

#### Step 4: Timeline时间平移（30分钟）
1. [ ] 创建TimelineTimeShiftDialog.tsx
2. [ ] 添加工具栏入口
3. [ ] 实现批量调整逻辑
4. [ ] 测试验证

#### Step 5: 嵌套计划导航（30-60分钟）
1. [ ] 创建LineDetail.tsx页面
2. [ ] 扩展路由配置
3. [ ] 实现双击导航
4. [ ] 创建面包屑导航
5. [ ] 测试验证

---

## 🔍 技术依赖

### 新增依赖
```bash
# 图片导出
pnpm add html2canvas
pnpm add -D @types/html2canvas

# Markdown编辑器（备注功能）
pnpm add react-markdown remark-gfm

# 可选：SVG导出优化
pnpm add save-svg-as-png
```

### 已有依赖
- ✅ date-fns（日期处理）
- ✅ antd（UI组件）
- ✅ @ant-design/icons（图标）
- ✅ zustand（状态管理）
- ✅ react-router-dom（路由）

---

## 📊 进度追踪

| 功能 | 分析 | 实现 | 测试 | 集成 | 状态 |
|-----|------|------|------|------|------|
| **基线系统** | ⬜ | ⬜ | ⬜ | ⬜ | 🔴 待开始 |
| **节点右键菜单** | ⬜ | ⬜ | ⬜ | ⬜ | 🔴 待开始 |
| **导出图片** | ⬜ | ⬜ | ⬜ | ⬜ | 🔴 待开始 |
| **Timeline时间平移** | ⬜ | ⬜ | ⬜ | ⬜ | 🔴 待开始 |
| **嵌套计划导航** | ⬜ | ⬜ | ⬜ | ⬜ | 🔴 待开始 |

---

## 🎯 成功标准

### 基线系统
- ✅ 基线在时间轴上正确显示（垂直线）
- ✅ 基线范围正确显示（半透明矩形）
- ✅ 拖拽创建基线范围流畅
- ✅ 编辑对话框可用
- ✅ 数据持久化

### 节点右键菜单
- ✅ 右键显示菜单
- ✅ 所有功能可用
- ✅ 菜单位置正确
- ✅ 交互流畅

### 导出图片
- ✅ PNG导出清晰（1x/2x/3x）
- ✅ 文件名和格式正确
- ✅ 导出范围正确
- ✅ 性能可接受

### Timeline时间平移
- ✅ 偏移计算正确
- ✅ 预览准确
- ✅ 批量更新成功
- ✅ 撤销支持

### 嵌套计划导航
- ✅ 双击导航正常
- ✅ 面包屑正确
- ✅ 返回功能正常
- ✅ URL路由正确

---

## 🚀 开始实施

**当前时间**: 2026-02-07  
**实施顺序**: 基线系统 → 节点右键菜单 → 导出图片 → Timeline时间平移 → 嵌套计划导航

**下一步**：开始分析和复刻基线系统！ 🔥
