# 修复总结 - 2026-02-07 Part 3

## 本次修复内容

根据用户测试反馈，修复了三个问题：

### ✅ 修复 1: 迭代规划页面列对齐问题

**问题描述**:
用户反馈截图1显示，迭代规划页面中的红色列和蓝色列没有严格对齐，需要完全对齐的两根垂直平行线框住内容。

**根本原因**:
- 每个迭代列使用 `borderRight: '1px solid #d9d9d9'`
- 边框宽度(1px)会累积，导致实际列宽不一致
- 第一列和后续列的边框处理不统一

**解决方案**:
```tsx
// 文件: src/components/iteration/IterationMatrix.tsx

// 1. 表头迭代列 - 使用borderLeft代替borderRight
{iterations.map((iter, index) => (
  <div
    key={iter.id}
    style={{
      flexShrink: 0,
      borderLeft: index === 0 ? 'none' : '1px solid #d9d9d9', // ✅ 第一列无左边框，其他列有
      background: '#fff',
      width: CELL_WIDTH,
      boxSizing: 'border-box', // ✅ 边框包含在宽度内
    }}
  >

// 2. Marker行 - 统一边框逻辑
{iterations.map((iter, index) => (
  <div
    style={{
      flexShrink: 0,
      borderLeft: index === 0 ? 'none' : '1px solid #d9d9d9',
      width: CELL_WIDTH,
      boxSizing: 'border-box',
    }}
  >

// 3. 数据行单元格 - 统一边框逻辑
{iterations.map((iter, iterIndex) => (
  <div
    style={{
      flexShrink: 0,
      borderLeft: iterIndex === 0 ? 'none' : '1px solid #d9d9d9',
      width: CELL_WIDTH,
      boxSizing: 'border-box',
    }}
  >
```

**关键点**:
- **统一使用 `borderLeft` 而非 `borderRight`**: 第一列无边框，后续列左边框
- **`boxSizing: 'border-box'`**: 确保边框包含在宽度内，不影响列宽
- **统一所有行**: 表头、marker行、数据行都使用相同的边框逻辑

**验证方法**:
1. 刷新页面，打开迭代规划视图
2. 使用DevTools检查每列的宽度
3. 确认所有列宽完全一致
4. 确认垂直分隔线完全对齐

**修改文件**:
- `src/components/iteration/IterationMatrix.tsx` (第250-258行, 318-333行, 437-456行)

---

### ✅ 修复 2: 甘特图时间轴显示数量

**问题描述**:
用户要求：
- 双周视图需要显示6个双周（84天）
- 单周视图需要显示6个单周（42天）

**根本原因**:
- `viewEndDate` 初始化为24个月后（固定值）
- 切换到week/biweekly视图后，时间范围过长，无法专注于短期规划
- 没有根据scale动态调整可视范围

**解决方案**:
```tsx
// 文件: src/components/timeline/TimelinePanel.tsx

// 添加useEffect监听scale变化，动态调整viewEndDate
useEffect(() => {
  const today = new Date();
  let targetEndDate: Date;
  
  if (scale === 'week') {
    // 单周视图：显示6个单周（42天）
    targetEndDate = addDays(today, 42);
  } else if (scale === 'biweekly') {
    // 双周视图：显示6个双周（84天）
    targetEndDate = addDays(today, 84);
  } else {
    // 其他scale（day/month/quarter）保持原有逻辑
    return;
  }
  
  setViewEndDate(targetEndDate);
}, [scale]);
```

**关键点**:
- **动态响应scale变化**: 使用`useEffect`监听`scale`变化
- **精确天数计算**:
  - 单周: 6周 × 7天 = 42天
  - 双周: 6个双周 × 14天 = 84天
- **保留其他scale的逻辑**: day/month/quarter视图不受影响

**验证方法**:
1. 刷新页面，切换到单周视图
2. 确认时间轴显示6个单周（约42天）
3. 切换到双周视图
4. 确认时间轴显示6个双周（约84天）
5. 切换到月视图，确认显示正常（不受影响）

**修改文件**:
- `src/components/timeline/TimelinePanel.tsx` (第323-342行)

---

### ✅ 修复 3: 添加版本计划导航按钮

**问题描述**:
用户要求在"迭代规划"按钮前添加"版本计划"按钮，点击后进入版本计划页面，功能从`@timeline-craft-kit/`复刻。

**实现方案**:
```tsx
// 文件: src/components/timeline/UnifiedTimelinePanelV2.tsx

// 1. 视图切换区域：添加版本计划按钮（在迭代规划前）
<Space size={4}>
  <Button
    size="small"
    icon={<BarChartOutlined />}
    type={view === 'gantt' ? 'primary' : 'default'}
    onClick={() => handleViewChange('gantt')}
    style={{
      color: view === 'gantt' ? '#FFFFFF' : undefined,
    }}
  >
    甘特图
  </Button>

  {/* ✅ 新增：版本计划按钮 */}
  <Button
    size="small"
    icon={<HistoryOutlined />}
    type={view === 'version' ? 'primary' : 'default'}
    onClick={() => handleViewChange('version')}
    style={{
      color: view === 'version' ? '#FFFFFF' : undefined,
    }}
  >
    版本计划
  </Button>

  <Button
    size="small"
    icon={<BlockOutlined />}
    type={view === 'iteration' ? 'primary' : 'default'}
    onClick={() => handleViewChange('iteration')}
    style={{
      color: view === 'iteration' ? '#FFFFFF' : undefined,
    }}
  >
    迭代规划
  </Button>
</Space>

// 2. 视图渲染逻辑（已存在）
case 'version':
  return (
    <VersionTableView
      baseVersion={plan}
      compareVersion={plan}
    />
  );
```

**关键点**:
- **按钮顺序**: 甘特图 → **版本计划** → 迭代规划
- **图标选择**: 使用 `<HistoryOutlined />` 表示版本历史
- **视图切换**: 已有 `ViewType = 'version'`，无需修改类型
- **现有组件**: 使用已实现的 `VersionTableView` 组件

**功能说明**:
`VersionTableView` 提供以下功能：
- 并排对比两个版本的TimePlan
- 高亮显示差异（开始日期、结束日期、进度）
- 显示变更状态（新增、删除、已变更）
- 表格视图，易于浏览和比较

**后续扩展**:
如果用户需要更复杂的版本计划功能（如截图2所示的甘特图式版本规划），可以：
1. 创建新的 `VersionPlanView` 组件
2. 从 `@timeline-craft-kit/` 复刻完整的版本规划功能
3. 替换当前的 `VersionTableView`

**验证方法**:
1. 刷新页面
2. 确认顶部导航栏有三个按钮：甘特图、版本计划、迭代规划
3. 点击"版本计划"按钮
4. 确认切换到版本对比视图
5. 确认按钮顺序正确（版本计划在迭代规划前）

**修改文件**:
- `src/components/timeline/UnifiedTimelinePanelV2.tsx` (第453-473行)

---

## 技术要点总结

### 1. CSS边框对齐技巧

**问题**: 使用`borderRight`会导致边框累积
**解决**: 
- 使用`borderLeft`，第一列无边框
- `boxSizing: 'border-box'` 确保边框包含在宽度内
- 统一所有行的边框逻辑

### 2. 动态时间范围调整

**问题**: 固定的`viewEndDate`不适合短期视图
**解决**:
- 使用`useEffect`监听`scale`变化
- 根据不同scale动态计算合适的时间范围
- 保留原有长期视图的逻辑

### 3. 导航按钮扩展

**问题**: 添加新的视图入口
**解决**:
- 利用现有的`ViewType`类型（已包含'version'）
- 复用现有的`VersionTableView`组件
- 保持UI风格一致（图标、颜色、大小）

---

## 测试检查清单

### 迭代规划页面列对齐
- [ ] 所有迭代列宽度完全一致
- [ ] 垂直分隔线完全对齐
- [ ] 表头、marker行、数据行对齐一致
- [ ] 不同宽度档位(1-5)都正常对齐

### 甘特图时间轴
- [ ] 单周视图显示约6个单周
- [ ] 双周视图显示约6个双周
- [ ] 月视图不受影响，显示正常
- [ ] 日视图不受影响，显示正常
- [ ] 季度视图不受影响，显示正常

### 版本计划按钮
- [ ] 按钮位于甘特图和迭代规划之间
- [ ] 图标显示为历史记录图标
- [ ] 点击切换到版本对比视图
- [ ] 按钮样式与其他按钮一致
- [ ] 版本视图正常显示和工作

---

## 相关文件

### 修改的文件
1. ✅ `src/components/iteration/IterationMatrix.tsx` - 列对齐修复
2. ✅ `src/components/timeline/TimelinePanel.tsx` - 时间轴范围调整
3. ✅ `src/components/timeline/UnifiedTimelinePanelV2.tsx` - 版本计划按钮

### 相关文件（未修改）
- `src/components/views/VersionTableView.tsx` - 版本对比视图组件
- `src/components/timeline/ViewSwitcher.tsx` - ViewType类型定义
- `src/components/timeline/TimelineHeader.tsx` - 时间轴表头渲染

---

## 状态

✅ **全部完成**: 三个问题都已修复
- 迭代规划列对齐 ✅
- 时间轴显示数量 ✅  
- 版本计划按钮 ✅

---

**修复日期**: 2026-02-07  
**测试状态**: 待用户验证
