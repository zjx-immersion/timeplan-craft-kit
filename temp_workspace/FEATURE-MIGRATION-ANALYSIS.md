# 功能复刻分析报告 - timeline-craft-kit → timeplan-craft-kit

**日期**: 2026-02-07  
**状态**: 🔄 进行中  
**完成度**: 约 75%

---

## 📊 整体功能对比

| 功能类别 | timeline-craft-kit | timeplan-craft-kit | 状态 | 优先级 |
|---------|-------------------|-------------------|------|--------|
| **核心甘特图** | ✅ 完整 | ✅ 完整 | 100% | P0 |
| **视图系统** | ✅ 5种视图 | ✅ 5种视图 | 90% | P0 |
| **编辑模式** | ✅ 完整 | ⚠️ 部分 | 70% | P0 |
| **工具栏** | ✅ 完整 | ✅ 完整 | 95% | P0 |
| **数据管理** | ✅ 完整 | ✅ 完整 | 100% | P0 |
| **基线系统** | ✅ 完整 | ❌ 未实现 | 0% | P1 |
| **导出功能** | ✅ 完整 | ⚠️ 部分 | 60% | P1 |
| **导入功能** | ✅ 完整 | ⚠️ 基础 | 50% | P1 |
| **迭代规划** | ✅ 完整 | ⚠️ 基础 | 40% | P2 |
| **上下文菜单** | ✅ 完整 | ⚠️ 部分 | 60% | P1 |

---

## 🎯 详细功能对比清单

### 一、核心甘特图功能

| 功能 | 源项目 | 目标项目 | 状态 | 说明 |
|------|--------|---------|------|------|
| **Timeline列表** | ✅ | ✅ | 100% | 折叠、颜色、快速菜单 |
| **时间轴渲染** | ✅ | ✅ | 100% | 多级刻度、节假日 |
| **Bar渲染** | ✅ | ✅ | 100% | 拖拽、调整大小 |
| **Milestone渲染** | ✅ | ✅ | 100% | 空心菱形 |
| **Gateway渲染** | ✅ | ✅ | 100% | 空心六边形 |
| **依赖关系线** | ✅ | ✅ | 100% | 正交路径、箭头 |
| **Today线** | ✅ | ✅ | 100% | 当前日期标记 |
| **时间刻度** | ✅ | ✅ | 100% | 5种刻度 |
| **缩放控制** | ✅ | ✅ | 100% | 放大缩小、今日 |

### 二、编辑模式功能

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **编辑模式切换** | ✅ | ✅ | 100% | P0 | 已实现 |
| **Timeline编辑对话框** | ✅ | ✅ | 100% | P0 | 已实现 |
| **节点编辑对话框** | ✅ | ✅ | 100% | P0 | 已实现 |
| **拖拽移动节点** | ✅ | ✅ | 100% | P0 | 已实现 |
| **调整节点大小** | ✅ | ✅ | 100% | P0 | 已实现 |
| **连接点交互** | ✅ | ✅ | 100% | P0 | 已实现 |
| **创建依赖关系** | ✅ | ✅ | 100% | P0 | 已实现 |
| **选中/Hover效果** | ✅ | ✅ | 100% | P0 | 已实现 |
| **撤销/重做** | ✅ | ✅ | 100% | P0 | 已修复 |
| **取消所有更改** | ✅ | ✅ | 100% | P0 | 已修复 |
| **保存更改** | ✅ | ✅ | 100% | P0 | 已实现 |
| **关系编辑对话框** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **批量编辑** | ✅ | ❌ | 0% | P2 | 需要复刻 |
| **Timeline排序** | ✅ | ❌ | 0% | P1 | **需要复刻** |

### 三、基线系统（⚠️ 重要缺失）

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **Baseline添加** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **Baseline编辑** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **Baseline删除** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **Baseline渲染** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **BaselineRange添加** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **BaselineRange拖拽创建** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **BaselineRange编辑** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **BaselineRange删除** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **BaselineRange渲染** | ✅ | ❌ | 0% | P1 | **需要复刻** |

**说明**: 基线系统数据模型已存在，但UI和交互完全未实现。

### 四、上下文菜单

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **Timeline右键菜单** | ✅ | ⚠️ | 40% | P1 | 部分功能缺失 |
| **节点右键菜单** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **Timeline快速菜单** | ✅ | ✅ | 100% | P0 | 已实现 |
| **背景右键菜单** | ✅ | ❌ | 0% | P2 | 需要复刻 |

**Timeline右键菜单缺失功能**:
- 添加基线
- 添加基线范围
- Timeline时间平移
- 批量编辑

**节点右键菜单需要实现**:
- 编辑节点
- 删除节点
- 复制节点
- 添加依赖关系
- 添加到基线
- 转换节点类型
- 查看嵌套计划

### 五、导入导出功能

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **导出JSON** | ✅ | ✅ | 100% | P0 | 已实现 |
| **导出CSV** | ✅ | ⚠️ | 50% | P1 | 功能存在，需验证 |
| **导出Excel** | ✅ | ⚠️ | 50% | P1 | 功能存在，需验证 |
| **导出图片PNG** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **导出图片JPEG** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **导出图片SVG** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **导出分辨率选择** | ✅ | ❌ | 0% | P2 | 需要复刻 |
| **导入JSON** | ✅ | ⚠️ | 50% | P1 | 功能存在，需验证 |
| **导入模式选择** | ✅ | ❌ | 0% | P2 | 合并/替换 |
| **数据验证** | ✅ | ⚠️ | 50% | P1 | 需加强 |

### 六、视图系统

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **甘特图视图** | ✅ | ✅ | 100% | P0 | 已实现 |
| **表格视图** | ✅ | ✅ | 95% | P0 | 已实现 |
| **矩阵视图** | ✅ | ✅ | 90% | P0 | 已实现 |
| **版本对比视图** | ✅ | ✅ | 90% | P0 | 已实现 |
| **迭代规划视图** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **视图内切换** | ✅ | ✅ | 100% | P0 | ✅ 已修复 |
| **视图状态同步** | ✅ | ✅ | 100% | P0 | 已实现 |

**说明**: 所有视图都应该在同一页面的红框区域内切换显示，不应该打开新页面。已验证代码实现是正确的（`UnifiedTimelinePanelV2.tsx` 第143-176行）。

### 七、Timeline时间平移

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **时间平移对话框** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **批量调整日期** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **保持依赖关系** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **预览变更** | ✅ | ❌ | 0% | P2 | 需要复刻 |

**说明**: `TimelineTimeShiftDialog.tsx` 组件未在目标项目中实现。

### 八、嵌套计划功能

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **嵌套计划展开** | ✅ | ⚠️ | 30% | P1 | 数据模型支持，UI未完成 |
| **嵌套计划折叠** | ✅ | ⚠️ | 30% | P1 | 数据模型支持，UI未完成 |
| **双击导航** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **面包屑导航** | ✅ | ❌ | 0% | P1 | **需要复刻** |
| **返回上级** | ✅ | ❌ | 0% | P1 | **需要复刻** |

### 九、迭代规划功能

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **产品选择器** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **迭代矩阵** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **MR卡片** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **MR详情对话框** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **MR选择器** | ✅ | ⚠️ | 60% | P1 | 需要增强 |
| **依赖可视化** | ✅ | ⚠️ | 50% | P1 | 需要增强 |
| **迭代标记** | ✅ | ⚠️ | 50% | P1 | 需要增强 |
| **迭代宽度调节** | ✅ | ❌ | 0% | P2 | 需要复刻 |

### 十、其他功能

| 功能 | 源项目 | 目标项目 | 状态 | 优先级 | 说明 |
|------|--------|---------|------|--------|------|
| **备注侧边栏** | ✅ | ❌ | 0% | P2 | 需要复刻 |
| **全屏模式** | ✅ | ✅ | 100% | P1 | 已实现 |
| **打印功能** | ✅ | ❌ | 0% | P3 | 需要复刻 |
| **主题切换** | ✅ | ❌ | 0% | P3 | 需要复刻 |
| **快捷键系统** | ✅ | ⚠️ | 50% | P2 | 需要增强 |
| **触摸手势** | ✅ | ❌ | 0% | P3 | 需要复刻 |

---

## 🚨 关键缺失功能（P0-P1优先级）

### 1. **基线系统** - P1 ⭐⭐⭐⭐⭐

**文件需要复刻**:
- `src/components/timeline/BaselineMarker.tsx` - 基线标记渲染
- `src/components/timeline/BaselineRangeMarker.tsx` - 基线范围标记渲染
- `src/components/timeline/BaselineRangeDragCreator.tsx` - 基线范围拖拽创建
- `src/components/timeline/BaselineEditDialog.tsx` - 基线编辑对话框
- `src/components/timeline/BaselineRangeEditDialog.tsx` - 基线范围编辑对话框
- `src/utils/baselineManager.ts` - 基线管理工具

**功能描述**:
- 基线（Baseline）：在时间轴上标记重要时间点（如发版日期、里程碑日期）
- 基线范围（BaselineRange）：标记重要时间区间（如开发阶段、测试阶段）
- 拖拽创建：在甘特图上拖拽鼠标创建基线范围
- 视觉效果：半透明彩色区域，带标签

**数据模型**: ✅ 已存在（`types/timeplanSchema.ts`）

**优先级理由**: 基线是项目管理的核心功能，用于标记关键时间点和阶段。

---

### 2. **节点右键菜单** - P1 ⭐⭐⭐⭐

**文件需要复刻**:
- `src/components/timeline/NodeContextMenu.tsx` - 节点上下文菜单（V1）
- `src/components/timeline/NodeContextMenuV2.tsx` - 节点上下文菜单（V2，推荐）

**功能列表**:
```
- 编辑节点 ✅（已有对话框）
- 删除节点 ✅（已有功能）
- 复制节点 ❌（需要实现）
- 添加依赖关系 ⚠️（已有连接点，需菜单入口）
- 添加到基线 ❌（需要实现）
- 转换节点类型 ❌（Bar ↔ Milestone ↔ Gateway）
- 查看嵌套计划 ❌（需要实现）
- 添加备注 ❌（需要实现）
```

**优先级理由**: 提升编辑效率，符合用户操作习惯。

---

### 3. **导出图片功能** - P1 ⭐⭐⭐

**文件需要复刻**:
- `src/utils/imageExport.ts` - 图片导出工具
- `src/components/dialogs/ExportDialog.tsx` - 导出对话框（扩展）

**功能列表**:
- 导出 PNG ❌
- 导出 JPEG ❌
- 导出 SVG ❌
- 分辨率选择（1x/2x/3x）❌
- 导出范围选择（当前视图/完整计划）❌

**技术实现**: 使用 `html2canvas` 或 `dom-to-image` 库

**优先级理由**: 项目演示、文档制作的重要功能。

---

### 4. **Timeline时间平移** - P1 ⭐⭐⭐

**文件需要复刻**:
- `src/components/timeline/TimelineTimeShiftDialog.tsx` - 时间平移对话框

**功能描述**:
- 选择一个Timeline
- 输入偏移天数（正数=延后，负数=提前）
- 批量调整该Timeline下所有节点的日期
- 可选：保持依赖关系一致性
- 预览变更

**优先级理由**: 批量调整日期的高效工具。

---

### 5. **嵌套计划导航** - P1 ⭐⭐⭐

**需要实现**:
- 双击节点打开嵌套计划（如果有 `nestedPlanId`）
- 面包屑导航（显示层级路径）
- 返回上级按钮
- URL路由支持（`/plan/:planId/line/:lineId`）

**文件涉及**:
- `src/pages/LineDetail.tsx` - ❌ 未实现
- 路由配置 - ⚠️ 需要扩展

**优先级理由**: 支持多层级计划管理。

---

## 📋 复刻优先级计划

### Phase 1: 关键功能增强（P0-P1，优先）

#### 1.1 基线系统（1-2天）
- [ ] 复刻 `BaselineMarker.tsx` 和 `BaselineRangeMarker.tsx`
- [ ] 复刻 `BaselineEditDialog.tsx` 和 `BaselineRangeEditDialog.tsx`
- [ ] 复刻 `BaselineRangeDragCreator.tsx`
- [ ] 集成到 `TimelinePanel.tsx`
- [ ] 添加工具栏按钮
- [ ] 添加右键菜单入口

#### 1.2 节点右键菜单（0.5-1天）
- [ ] 复刻 `NodeContextMenuV2.tsx`
- [ ] 实现复制节点功能
- [ ] 实现转换节点类型功能
- [ ] 集成到 `LineRenderer.tsx`

#### 1.3 导出图片功能（0.5-1天）
- [ ] 复刻 `imageExport.ts`
- [ ] 扩展 `ExportDialog.tsx`
- [ ] 添加分辨率选择
- [ ] 测试各种格式

#### 1.4 Timeline时间平移（0.5天）
- [ ] 复刻 `TimelineTimeShiftDialog.tsx`
- [ ] 添加工具栏/右键菜单入口
- [ ] 实现批量日期调整逻辑

### Phase 2: 功能完善（P2，次要）

#### 2.1 嵌套计划导航（1天）
- [ ] 创建 `LineDetail.tsx` 页面
- [ ] 实现双击导航
- [ ] 实现面包屑导航
- [ ] 扩展路由配置

#### 2.2 迭代规划增强（1天）
- [ ] 增强 MR 管理功能
- [ ] 优化迭代矩阵交互
- [ ] 添加迭代宽度调节
- [ ] 完善依赖可视化

#### 2.3 备注侧边栏（0.5天）
- [ ] 复刻 `NotesSidebar.tsx`
- [ ] 集成 Markdown 编辑器
- [ ] 实现侧边栏显示/隐藏

### Phase 3: 优化和扩展（P3，可选）

- [ ] 打印功能
- [ ] 主题切换
- [ ] 触摸手势支持
- [ ] 批量操作
- [ ] 高级筛选
- [ ] 快捷键自定义

---

## 🔍 当前视图切换问题验证

### 问题描述
用户反馈："页面中右上角导航点击后，页面需要显示在红框处，而不是单独显示到一个页面中"

### 代码验证

**文件**: `UnifiedTimelinePanelV2.tsx`

```typescript
// 第183-201行
return (
  <div style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
    {/* 视图内容 */}
    <div style={{ flex: 1, overflow: 'hidden' }}>
      {renderView()}  // ✅ 在同一容器内切换视图
    </div>
  </div>
);

// 第128-180行 - renderView()
const renderView = () => {
  switch (view) {
    case 'gantt':   return <TimelinePanel ... />;     // ✅ 甘特图
    case 'table':   return <TableView ... />;         // ✅ 表格
    case 'matrix':  return <MatrixView ... />;        // ✅ 矩阵
    case 'version': return <VersionTableView ... />;  // ✅ 版本对比
    case 'iteration': return <IterationView ... />;   // ✅ 迭代规划
  }
};
```

### 结论
✅ **代码实现是正确的**，所有视图都在同一页面的红框区域内切换。

**如果用户看到新页面，可能的原因**:
1. 浏览器缓存未刷新（需要 Ctrl+Shift+R 强制刷新）
2. 构建未更新（需要重新运行 `pnpm run build`）
3. 某些视图内部有导航逻辑

**验证方法**:
1. 打开浏览器开发者工具
2. 点击视图切换按钮
3. 观察 URL 是否改变
   - ✅ 如果URL不变 → 说明是同一页面内切换
   - ❌ 如果URL改变 → 说明有路由跳转

---

## 📝 下一步实施建议

### 立即执行（本次会话）

**优先级排序**:
1. **验证视图切换** - 确保在同一页面显示 ✅
2. **复刻基线系统** - 最重要的缺失功能 ⭐⭐⭐⭐⭐
3. **复刻节点右键菜单** - 提升编辑效率 ⭐⭐⭐⭐
4. **复刻导出图片** - 常用功能 ⭐⭐⭐

### 实施策略

**阶段1**（本次会话）：
1. ✅ 确认视图切换在同一页面
2. 开始复刻基线系统（核心UI组件）
3. 测试基线功能

**阶段2**（后续会话）：
1. 完成基线系统（所有交互）
2. 复刻节点右键菜单
3. 复刻导出图片功能

**阶段3**（后续会话）：
1. 复刻Timeline时间平移
2. 复刻嵌套计划导航
3. 增强迭代规划功能

---

## 📊 功能复刻工作量估算

| 功能类别 | 预计工作量 | 优先级 | 状态 |
|---------|-----------|--------|------|
| 基线系统 | 1-2天 | P1 | 待开始 |
| 节点右键菜单 | 0.5-1天 | P1 | 待开始 |
| 导出图片 | 0.5-1天 | P1 | 待开始 |
| Timeline时间平移 | 0.5天 | P1 | 待开始 |
| 嵌套计划导航 | 1天 | P1 | 待开始 |
| 迭代规划增强 | 1天 | P1 | 待开始 |
| 其他优化 | 1-2天 | P2-P3 | 待开始 |
| **总计** | **5-8天** | - | - |

---

## 🎯 本次会话目标

### 目标1：确认视图切换问题 ✅
- [ ] 验证代码实现
- [ ] 指导用户测试
- [ ] 确认是否在同一页面

### 目标2：开始复刻基线系统
- [ ] 分析源项目基线组件
- [ ] 创建基线标记渲染器
- [ ] 创建基线编辑对话框
- [ ] 集成到TimelinePanel
- [ ] 测试基线功能

### 目标3：复刻节点右键菜单
- [ ] 分析源项目菜单组件
- [ ] 适配Ant Design Menu组件
- [ ] 实现菜单功能
- [ ] 集成到LineRenderer
- [ ] 测试右键菜单

---

**接下来我将：**
1. 先确认视图切换问题
2. 然后开始复刻基线系统（最重要的缺失功能）
3. 采用TDD方式，确保每个功能集成后都能测试

**请确认：**
- 是否继续开始复刻基线系统？
- 还是先解决视图切换问题？
