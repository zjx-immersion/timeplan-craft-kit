# TimePlan Craft Kit - 完整方案设计文档

**版本**: v1.0.0  
**日期**: 2026-02-09  
**状态**: ✅ 已完成  
**项目**: 智能时间线管理平台

---

## 📋 文档目录

1. [项目概述](#项目概述)
2. [技术架构](#技术架构)
3. [核心功能](#核心功能)
4. [数据模型](#数据模型)
5. [界面设计](#界面设计)
6. [性能优化](#性能优化)
7. [部署方案](#部署方案)

---

## 🎯 项目概述

### 产品定位

**TimePlan Craft Kit** 是一款面向复杂项目管理的智能时间线管理平台，专为多团队协作和敏捷开发场景设计。

### 核心价值

1. **可视化项目管理** - 将复杂的项目计划转化为直观的甘特图视图
2. **多视角管理** - 提供甘特图、表格、模块规划等多种视图
3. **灵活的数据模型** - 基于 Schema 的扩展架构，适应不同业务场景
4. **高效协作** - 支持多团队、跨模块的协同工作
5. **智能依赖管理** - 自动识别和可视化任务依赖关系

### 目标用户

- **项目经理 (PM)**: 管理整体项目进度，跟踪关键节点
- **团队负责人 (TL)**: 管理团队任务，协调资源分配
- **产品经理 (PO)**: 规划产品版本，管理特性交付
- **开发人员**: 查看任务安排，了解依赖关系
- **管理层**: 查看项目全局，做出决策

### 应用场景

- 软件项目管理（敏捷/瀑布）
- 产品版本规划
- 多团队协作项目
- 研发迭代管理
- 复杂项目的里程碑管理

---

## 🏗️ 技术架构

### 技术栈

| 层次 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **前端框架** | React | 19.x | UI渲染和组件化 |
| **类型系统** | TypeScript | 5.6.x | 类型安全 |
| **UI组件库** | Ant Design | 5.22.x | 企业级UI组件 |
| **状态管理** | Zustand | 5.0.x | 轻量级状态管理 |
| **路由** | React Router | 7.1.x | 路由管理 |
| **日期处理** | date-fns | 4.1.x | 日期计算 |
| **构建工具** | Vite | 6.0.x | 快速构建 |
| **测试框架** | Vitest | 3.0.x | 单元测试 |

### 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                     用户界面层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐         │
│  │ 甘特图   │  │ 表格视图 │  │ 模块规划视图  │         │
│  └──────────┘  └──────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     组件层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐         │
│  │TimelinePanel│ │TableView │  │ModuleIterationView│   │
│  │ TimelineHeader│ │VersionCompareView│               │
│  │ LineRenderer │ │ RelationRenderer │                │
│  └──────────┘  └──────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐         │
│  │useBarResize│ │useTimelineDrag│ │useUndoRedo│       │
│  │ 拖拽调整   │  │ 时间线拖拽 │  │  撤销重做   │       │
│  └──────────┘  └──────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                     数据层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐         │
│  │ dateUtils│  │ holidayUtils│ │timelineCoordinates│  │
│  │ 日期计算  │  │  假期判断  │  │   坐标转换   │       │
│  └──────────┘  └──────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│                   存储层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐         │
│  │ Zustand  │  │localStorage│  │  内存状态    │         │
│  └──────────┘  └──────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────┘
```

### 核心设计原则

1. **模块化设计**
   - 组件高内聚、低耦合
   - 每个组件职责单一
   - 易于测试和维护

2. **性能优化**
   - React.memo 避免不必要渲染
   - useMemo/useCallback 缓存计算结果
   - 虚拟滚动处理大数据量

3. **类型安全**
   - 100% TypeScript 覆盖
   - 严格的类型检查
   - 完善的类型定义

4. **可扩展性**
   - 基于 Schema 的数据模型
   - 插件化的渲染器
   - 灵活的主题系统

---

## ✨ 核心功能

### 1. 甘特图视图

#### 1.1 时间轴管理

**多种时间刻度**
- 日视图（40px/天）
- 周视图（40px/天，按周分组）
- 双周视图（20px/天，显示6个双周）
- 月视图（5px/天）
- 季度视图（2.2px/天）

**时间轴对齐**
- 统一的坐标计算系统（`timelineCoordinates.ts`）
- 基于"天"为单位的精确定位
- TimelineHeader 和任务元素共享同一坐标系
- 像素级精确对齐

**日期计算**
- 本地时间解析（`parseDateAsLocal`）
- 假期和非工作日判断
- 跨时区一致性保证

#### 1.2 任务管理

**三种元素类型**
- **计划单元 (LinePlan)**: 带起止日期的任务条
- **里程碑 (Milestone)**: 关键时间点标记
- **关口 (Gateway)**: 决策点或检查点

**任务操作**
- 拖拽移动：调整开始时间
- 拖拽调整：修改起止日期
- 双击编辑：修改任务属性
- 右键菜单：快捷操作

**视觉反馈**
- 悬停显示完整日期信息（Tooltip）
- 拖拽时实时显示日期
- 不同类型的颜色区分
- 进度显示（0-100%）

#### 1.3 依赖关系

**连线类型**
- FS (Finish-to-Start): 前置任务完成后开始
- SS (Start-to-Start): 与前置任务同时开始
- FF (Finish-to-Finish): 与前置任务同时完成
- SF (Start-to-Finish): 前置任务开始后完成

**可视化**
- SVG 绘制的连接线
- 箭头指向依赖方向
- 不同类型的线条样式
- 悬停高亮显示

#### 1.4 基线管理

**基线功能**
- 时间点基线：标记特定日期
- 时间范围基线：标记时间段
- 基线对比：显示计划vs实际偏差
- 颜色区分：不同基线不同颜色

### 2. 表格视图

**表格列**
- 名称（带类型图标）
- 类型（计划单元/里程碑/关口）
- 开始日期
- 结束日期
- 时长（天数）
- 依赖关系
- 进度
- 负责人

**表格操作**
- 排序：按任意列排序
- 筛选：按类型、状态筛选
- 编辑：行内编辑
- 导出：导出为Excel/CSV

### 3. 模块规划视图

**两级分组**
- 一级分组：按产品线（电子架构、感知算法、规划决策）
- 二级分组：按模块（E0架构、视觉感知、行为决策等）

**卡片式展示**
- MR类型标识
- 负责人信息
- 起止日期
- 进度百分比
- 依赖关系可视化

**交互功能**
- 折叠/展开产品线面板
- 点击卡片查看详情
- 拖拽调整顺序

### 4. 视图切换与交互

**智能定位**
- 初次加载：自动定位到今日（居中显示）
- 返回甘特图：自动定位到今日
- 视图切换：保持滚动位置相对比例

**滚动位置保持**
- 切换前计算相对比例
- 切换后应用相同比例
- 保持时间上下文一致

### 5. 数据管理

**撤销/重做**
- 支持所有编辑操作
- 历史记录管理
- Ctrl+Z / Ctrl+Y 快捷键

**数据持久化**
- localStorage 自动保存
- 手动保存确认
- 数据迁移支持

**数据导入导出**
- JSON格式导入导出
- 支持批量操作
- 数据校验

---

## 📊 数据模型

### Schema 系统

```typescript
// 核心数据结构
interface TimePlan {
  id: string;
  title: string;
  schemaId: string;
  lines: Line[];           // 所有元素（任务、里程碑、关口）
  timelines: Timeline[];   // 时间线分组
  relations: Relation[];   // 依赖关系
  baselines: Baseline[];   // 基线
  baselineRanges: BaselineRange[];  // 时间范围基线
  viewConfig?: ViewConfig; // 视图配置
}

// 元素定义
interface Line {
  id: string;
  type: 'lineplan' | 'milestone' | 'gateway';
  schemaId: string;
  label: string;
  startDate: Date;
  endDate?: Date;
  timelineId: string;
  progress?: number;
  color?: string;
  dependencies?: string[];
  metadata?: Record<string, any>;
}

// 时间线分组
interface Timeline {
  id: string;
  label: string;
  schemaId: string;
  color?: string;
}

// 依赖关系
interface Relation {
  id: string;
  fromLineId: string;
  toLineId: string;
  type: 'FS' | 'SS' | 'FF' | 'SF';
}

// 基线
interface Baseline {
  id: string;
  date: Date;
  label: string;
  color?: string;
}

// 时间范围基线
interface BaselineRange {
  id: string;
  startDate: Date;
  endDate: Date;
  label: string;
  color?: string;
}
```

### 数据流

```
用户操作 → 事件处理器 → 状态更新 → 组件重渲染
    ↓
自动保存到 localStorage
    ↓
支持撤销/重做
```

---

## 🎨 界面设计

### 布局结构

```
┌─────────────────────────────────────────────────────────┐
│                    顶部工具栏                            │
│  [标题] [视图切换] [操作按钮] [今天] [时间刻度]         │
└─────────────────────────────────────────────────────────┘
┌────────┬────────────────────────────────────────────────┐
│        │                                                 │
│        │                                                 │
│  左侧  │               主要内容区域                      │
│  侧边  │          (甘特图/表格/模块规划)                 │
│  栏    │                                                 │
│        │                                                 │
│        │                                                 │
└────────┴────────────────────────────────────────────────┘
```

### 甘特图布局

```
┌─────────────────────────────────────────────────────────┐
│                  时间轴头部                              │
│  ┌───────┬───────┬───────┬───────┬───────┐            │
│  │ 2026年│      │      │      │      │ 今日红线       │
│  ├───┬───┼───┬───┼───┬───┼───┬───┼───┬───┤            │
│  │1月│2月│3月│4月│5月│6月│7月│8月│9月│10月│            │
│  └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘            │
└─────────────────────────────────────────────────────────┘
┌──────────┬──────────────────────────────────────────────┐
│ Timeline │                                              │
│    1     │  ■■■■■ 任务1  ◆里程碑  ▼关口               │
│          │                                              │
├──────────┼──────────────────────────────────────────────┤
│ Timeline │                                              │
│    2     │      ■■■■■■ 任务2                         │
│          │                                              │
└──────────┴──────────────────────────────────────────────┘
```

### 颜色系统

**时间轴**
- 周末：`#fafafa`（浅灰）
- 工作日：`#ffffff`（白色）
- 假期：`#fffbe6`（浅黄）
- 今日线：`#ff4d4f`（红色）

**任务元素**
- 计划单元：`#1890ff`（蓝色）
- 里程碑：`#52c41a`（绿色）
- 关口：`#faad14`（橙色）
- 基线：`#722ed1`（紫色）

**状态颜色**
- 进行中：`#1890ff`（蓝色）
- 已完成：`#52c41a`（绿色）
- 已延期：`#ff4d4f`（红色）
- 未开始：`#d9d9d9`（灰色）

---

## ⚡ 性能优化

### 1. 渲染优化

**虚拟化**
- 只渲染可见区域的任务
- 滚动时动态加载
- 支持大数据量（1000+ 任务）

**React 优化**
```typescript
// 组件记忆化
const LineRenderer = React.memo(({ line, scale }) => {
  // ...
}, (prevProps, nextProps) => {
  return prevProps.line.id === nextProps.line.id &&
         prevProps.scale === nextProps.scale;
});

// 计算缓存
const position = useMemo(() => {
  return getPositionFromDate(line.startDate, viewStartDate, scale);
}, [line.startDate, viewStartDate, scale]);
```

### 2. 计算优化

**坐标计算缓存**
- 统一的坐标计算模块（`timelineCoordinates.ts`）
- 避免重复计算
- 精确到像素

**日期计算优化**
- 预计算假期列表
- 缓存日期范围
- 避免重复解析

### 3. 数据优化

**状态更新**
- 使用 Zustand 的 immer 中间件
- 避免不必要的状态更新
- 批量更新

**持久化**
- 防抖保存（300ms）
- 仅保存变更数据
- 压缩存储

---

## 🚀 部署方案

### 开发环境

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 运行测试
npm test

# 构建生产版本
npm run build
```

### 生产环境

**构建优化**
- 代码分割（Code Splitting）
- Tree Shaking
- 压缩优化（Gzip/Brotli）

**部署流程**
1. `npm run build` 生成生产构建
2. 部署 `dist/` 目录到静态服务器
3. 配置 NGINX/CDN
4. 启用 HTTPS

**性能指标**
- 首屏加载 < 2s
- 组件渲染 < 100ms
- 拖拽响应 < 50ms
- Lighthouse 评分 > 90

---

## 📚 相关文档

### 核心文档
- [快速开始](./QUICK-START.md) - 5分钟上手指南
- [视图指南](./VIEW-GUIDE.md) - 各视图使用说明
- [用户指南](./V11.3-USER-GUIDE.md) - 完整使用手册

### 技术文档
- [时间轴计算分析](./TIMELINE-CALCULATION-ANALYSIS.md) - 坐标系统详解
- [迭代视图设计](./ITERATION-VIEW-DESIGN.md) - 迭代视图实现
- [模块规划指南](./MODULE-ITERATION-VIEW-GUIDE.md) - 模块视图使用

### PRD文档
- [PRD - 甘特图核心功能](../../prds/01-PRD-甘特图核心功能.md)
- [PRD - 迭代规划视图](../../prds/02-PRD-迭代规划视图.md)
- [PRD - 数据管理与协作](../../prds/03-PRD-数据管理与协作.md)

---

## 📊 项目统计

### 代码量
```
生产代码: ~11,000 行
测试代码: ~5,000 行
总代码: ~16,000 行
组件数: 70+
```

### 测试覆盖
```
单元测试: 44+ 用例
测试覆盖率: ~87%
```

### 文档
```
技术文档: 9 份
PRD文档: 4 份
总文档: ~50,000 字
```

---

## ✅ 项目状态

**当前版本**: v0.2.0  
**开发状态**: ✅ 已完成  
**测试状态**: ✅ 通过  
**部署状态**: ✅ 可生产使用

---

**文档版本**: v1.0.0  
**最后更新**: 2026-02-09  
**维护者**: 前端团队
