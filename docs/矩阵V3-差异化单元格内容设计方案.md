# 矩阵V3 - 差异化单元格内容设计方案

**日期**: 2026-02-12  
**版本**: v3.2.0  
**状态**: 设计中  

---

## 设计目标

根据矩阵列的类型（里程碑 vs 门禁），在单元格中显示差异化的内容：

| 列类型 | 显示内容 |
|--------|----------|
| **里程碑 (Milestone)** | 产品需求列表(SSTS)、目标、交付版本、车型节点交付物 |
| **门禁 (Gateway)** | 质量门禁要求、检查项、通过状态 |

---

## 数据模型扩展

### 1. 里程碑相关属性 (Milestone Attributes)

```typescript
interface MilestoneAttributes {
  // SSTS需求列表
  sstsList: {
    id: string;
    name: string;
    status: 'pending' | 'in-review' | 'approved';
  }[];
  
  // 目标描述
  objectives: string[];
  
  // 交付产品版本
  deliverableVersion: {
    version: string;      // 如 "v2.1.0"
    branch: string;       // 如 "release/orion-x-2026"
    commitId?: string;    // Git commit
  };
  
  // 车型节点交付物
  vehicleDeliverables: {
    node: string;         // 车型节点，如 "E0", "E1", "E2"
    items: {
      name: string;       // 交付物名称
      type: 'document' | 'software' | 'hardware' | 'report';
      status: 'pending' | 'ready' | 'delivered';
    }[];
  }[];
}
```

### 2. 门禁相关属性 (Gateway Attributes)

```typescript
interface GatewayAttributes {
  // 门禁类型
  gatewayType: 'technical' | 'quality' | 'process' | 'milestone';
  
  // 检查项列表
  checkItems: {
    id: string;
    name: string;         // 检查项名称
    category: string;     // 类别：代码审查/测试/文档等
    weight: number;       // 权重
    required: boolean;    // 是否必须
    status: 'pending' | 'in-progress' | 'passed' | 'failed' | 'waived';
    owner: string;        // 负责人
    evidence?: string;    // 证据/附件链接
    comment?: string;     // 备注
  }[];
  
  // 整体状态
  overallStatus: 'pending' | 'in-review' | 'approved' | 'rejected';
  
  // 评审信息
  reviewInfo?: {
    reviewers: string[];
    reviewDate?: Date;
    comments: string[];
  };
}
```

### 3. 扩展 MatrixCellV3

```typescript
interface MatrixCellV3 {
  // ... 现有字段
  
  // 时间节点类型
  timeNodeType: 'milestone' | 'gateway';
  
  // 里程碑特定内容
  milestoneContent?: {
    sstsCount: number;           // SSTS数量
    sstsList: string[];          // SSTS名称列表（摘要）
    objectiveSummary: string;    // 目标摘要
    deliverableVersion?: string; // 交付版本
    vehicleNodes: string[];      // 涉及车型节点
    deliverableCount: number;    // 交付物数量
  };
  
  // 门禁特定内容
  gatewayContent?: {
    gatewayType: string;         // 门禁类型
    checkItemCount: number;      // 检查项总数
    passedCount: number;         // 已通过数
    failedCount: number;         // 失败数
    pendingCount: number;        // 待检查数
    overallStatus: string;       // 整体状态
    completionRate: number;      // 完成率
  };
}
```

---

## UI设计方案

### 1. 里程碑单元格 (MilestoneCell)

```
┌──────────────────────────────────┐
│ 🎯 里程碑名称                     │
├──────────────────────────────────┤
│ 📋 SSTS: 5个需求                  │
│    [通过✓] SSTS-001 需求分析      │
│    [通过✓] SSTS-002 架构设计      │
│    [评审中] SSTS-003 接口定义     │
│    [待开始] SSTS-004 ...          │
├──────────────────────────────────┤
│ 🎯 目标: 完成E1阶段核心功能开发   │
├──────────────────────────────────┤
│ 📦 交付版本: v2.1.0               │
├──────────────────────────────────┤
│ 🚗 交付物 (E0节点):               │
│    ✓ 需求规格书                   │
│    ✓ 架构设计文档                 │
│    ⏳ 测试用例 (进行中)           │
└──────────────────────────────────┘
```

### 2. 门禁单元格 (GatewayCell)

```
┌──────────────────────────────────┐
│ 🚪 门禁名称                       │
│ 类型: 技术门禁                    │
├──────────────────────────────────┤
│ 进度: ████████░░░░ 80%           │
│ 8/10 检查项通过                   │
├──────────────────────────────────┤
│ ✅ 代码审查 (5/5)                │
│ ✅ 单元测试>80% (85%)            │
│ ⏳ 集成测试 (3/5)                │
│ ❌ 性能测试 (待开始)             │
├──────────────────────────────────┤
│ 状态: 🟡 审核中                   │
│ 审核人: 张三, 李四               │
└──────────────────────────────────┘
```

### 3. 简化视图（矩阵单元格默认显示）

#### 里程碑简化视图
```
┌─────────────────┐
│ 🎯              │
│ 5个SSTS         │
│ v2.1.0          │
│ E0,E1           │
│ ████████░░ 80% │
└─────────────────┘
```

#### 门禁简化视图
```
┌─────────────────┐
│ 🚪              │
│ 技术门禁        │
│ 8/10通过        │
│ ████████░░ 80% │
│ 🟡 审核中       │
└─────────────────┘
```

---

## 组件架构

### 组件层级

```
MatrixTableV3
├── MatrixCellV3 (容器)
│   ├── MilestoneCellContent (里程碑专用)
│   │   ├── SSTSList
│   │   ├── ObjectiveSummary
│   │   ├── DeliverableVersion
│   │   └── VehicleDeliverables
│   └── GatewayCellContent (门禁专用)
│       ├── GatewayHeader (类型+状态)
│       ├── ProgressBar
│       ├── CheckItemList
│       └── ReviewInfo
```

### 组件接口设计

```typescript
// 单元格内容组件通用接口
interface CellContentProps {
  cell: MatrixCellV3;
  timeNode: TimeNode;
  onClick?: () => void;
  compact?: boolean;  // 是否为紧凑模式（矩阵中显示）
}

// 里程碑单元格
interface MilestoneCellProps extends CellContentProps {
  content: MatrixCellV3['milestoneContent'];
}

// 门禁单元格
interface GatewayCellProps extends CellContentProps {
  content: MatrixCellV3['gatewayContent'];
}
```

---

## 详细对话框设计

### 里程碑详情对话框

```
┌──────────────────────────────────────────────────────────────┐
│ 🎯 E1 里程碑 - 电子电器架构                        [× 关闭]  │
├──────────────────────────────────────────────────────────────┤
│ 基本信息                                                     │
│ • 日期: 2026-03-15                                          │
│ • 负责人: 架构团队                                          │
│ • 状态: 🟡 进行中                                           │
├──────────────────────────────────────────────────────────────┤
│ 📋 SSTS需求列表 (5个)                                        │
│ ┌────────────────────────────────────────────────────────┐  │
│ │ ✓ SSTS-001 域控架构方案设计         [已批准] 张三     │  │
│ │ ✓ SSTS-002 传感器配置规范           [已批准] 李四     │  │
│ │ ⏳ SSTS-003 系统通信协议              [评审中] 王五     │  │
│ │ ○ SSTS-004 电源管理策略             [待开始] -        │  │
│ │ ○ SSTS-005 故障诊断设计             [待开始] -        │  │
│ └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│ 🎯 目标                                                      │
│ • 完成E1阶段电子电器架构设计                                  │
│ • 确定传感器配置方案                                          │
│ • 完成系统通信协议定义                                        │
├──────────────────────────────────────────────────────────────┤
│ 📦 交付版本: v2.1.0 (分支: release/e1-arch)                  │
├──────────────────────────────────────────────────────────────┤
│ 🚗 车型节点交付物                                            │
│ ┌──────────┬─────────────────────────────────────────────┐  │
│ │ E0节点   │ ✅ 需求规格书                                 │  │
│ │          │ ✅ 架构设计文档                               │  │
│ │          │ ⏳ 接口定义文档                               │  │
│ ├──────────┼─────────────────────────────────────────────┤  │
│ │ E1节点   │ ⏳ 详细设计文档                               │  │
│ │          │ ○ 测试报告                                   │  │
│ └──────────┴─────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 门禁详情对话框

```
┌──────────────────────────────────────────────────────────────┐
│ 🚪 E1技术评审门禁 - 电子电器架构                   [× 关闭]  │
├──────────────────────────────────────────────────────────────┤
│ 基本信息                                                     │
│ • 类型: 技术门禁                                              │
│ • 计划日期: 2026-03-15                                       │
│ • 审核人: 张三, 李四, 王五                                    │
│ • 整体状态: 🟡 审核中                                         │
├──────────────────────────────────────────────────────────────┤
│ 检查项列表 (10项)                                            │
│ ┌────────────────────────────────────────────────────────┐  │
│ │ 类别: 代码质量 (3项)                                   │  │
│ │ ✅ 代码审查完成             [已通过] 张三 2026-03-10  │  │
│ │ ✅ 静态分析无高危问题        [已通过] 李四 2026-03-11  │  │
│ │ ⏳ 代码覆盖率>80%            [审核中] 王五 -          │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ 类别: 测试验证 (4项)                                   │  │
│ │ ✅ 单元测试通过             [已通过] 张三 2026-03-12  │  │
│ │ ✅ 集成测试通过             [已通过] 李四 2026-03-13  │  │
│ │ ❌ 性能测试达标             [未通过] 王五 2026-03-14  │  │
│ │    └─ 备注: 响应时间超标，需优化                         │  │
│ │ ⏳ 安全扫描无漏洞            [待开始] - -             │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ 类别: 文档交付 (3项)                                   │  │
│ │ ✅ 设计文档完整              [已通过] 张三 2026-03-10 │  │
│ │ ⏳ API文档更新               [审核中] 李四 -          │  │
│ │ ○ 部署手册                  [待开始] - -             │  │
│ └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│ 统计                                                         │
│ • 总计: 10项  |  已通过: 6项  |  未通过: 1项  |  待完成: 3项 │
│ • 完成率: 70%                                                │
│ • 预估风险: 性能测试未通过可能影响E1里程碑                    │
└──────────────────────────────────────────────────────────────┘
```

---

## 实现计划

### Phase 1: 数据层扩展

| 任务 | 文件 | 说明 |
|------|------|------|
| 扩展 MatrixCellV3 类型 | `types.ts` | 添加 milestoneContent/gatewayContent |
| 扩展计算逻辑 | `calculateMatrix.ts` | 提取里程碑/门禁特定属性 |
| 添加类型守卫 | `typeGuards.ts` | 区分里程碑和门禁数据 |

### Phase 2: 组件开发

| 任务 | 文件 | 说明 |
|------|------|------|
| 里程碑单元格组件 | `MilestoneCellContent.tsx` | 里程碑专用显示 |
| 门禁单元格组件 | `GatewayCellContent.tsx` | 门禁专用显示 |
| 单元格容器 | `MatrixCellV3.tsx` | 根据类型渲染不同组件 |
| 里程碑详情对话框 | `MilestoneDetailDialog.tsx` | 里程碑完整信息 |
| 门禁详情对话框 | `GatewayDetailDialog.tsx` | 门禁完整信息 |

### Phase 3: 集成与优化

| 任务 | 文件 | 说明 |
|------|------|------|
| 更新 MatrixTableV3 | `MatrixTableV3.tsx` | 使用新的单元格组件 |
| 更新 MatrixViewV3 | `MatrixViewV3.tsx` | 集成详情对话框 |
| 样式优化 | `matrix-styles.css` | 统一视觉风格 |

---

## 数据映射规则

### 从 Line 提取里程碑内容

```typescript
function extractMilestoneContent(line: Line): MilestoneContent {
  const attrs = line.attributes || {};
  
  return {
    sstsCount: attrs.sstsList?.length || 0,
    sstsList: attrs.sstsList?.map((s: any) => s.name)?.slice(0, 3) || [],
    objectiveSummary: attrs.objectives?.[0] || '暂无目标描述',
    deliverableVersion: attrs.deliverableVersion?.version,
    vehicleNodes: attrs.vehicleDeliverables?.map((v: any) => v.node) || [],
    deliverableCount: attrs.vehicleDeliverables?.reduce(
      (sum: number, v: any) => sum + (v.items?.length || 0), 0
    ) || 0,
  };
}
```

### 从 Line 提取门禁内容

```typescript
function extractGatewayContent(line: Line): GatewayContent {
  const attrs = line.attributes || {};
  const checkItems = attrs.checkItems || [];
  
  const passed = checkItems.filter((c: any) => c.status === 'passed').length;
  const failed = checkItems.filter((c: any) => c.status === 'failed').length;
  const pending = checkItems.filter((c: any) => 
    c.status === 'pending' || c.status === 'in-progress'
  ).length;
  
  return {
    gatewayType: attrs.gatewayType || 'technical',
    checkItemCount: checkItems.length,
    passedCount: passed,
    failedCount: failed,
    pendingCount: pending,
    overallStatus: attrs.overallStatus || 'pending',
    completionRate: checkItems.length > 0 ? passed / checkItems.length : 0,
  };
}
```

---

## 验收标准

- [ ] 里程碑单元格显示SSTS数量、版本、车型节点
- [ ] 门禁单元格显示检查项进度、通过/失败数
- [ ] 点击里程碑单元格打开里程碑详情对话框
- [ ] 点击门禁单元格打开门禁详情对话框
- [ ] 详情对话框显示完整信息并可交互
- [ ] 代码通过TypeScript类型检查
- [ ] 单元测试覆盖新功能

---

**设计完成时间**: 2026-02-12  
**设计者**: AI Assistant  
**评审状态**: 待确认
